# -*- coding: utf-8 -*-
"""
/***************************************************************************
 MapMd Utility Methods
                                 A QGIS plugin
 This plugin uses Map.md API.
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                             -------------------
        begin                : 2019-05-21
        git sha              : $Format:%H$
        copyright            : (C) 2019 by Victor Pogor
        email                : victor.pogor@outlook.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""

import csv
from qgis.utils import iface # pylint: disable=import-error

def read_csv_header(filename):
    """ Read CSV header. """
    try:
        infile = open(filename, 'r', encoding='utf-8')
    except IOError:
        iface.messageBar().pushCritical(
            "Input CSV File",
            "Failure opening " + filename)
        return None

    try:
        dialect = csv.Sniffer().sniff(infile.read(4096))
    except UnicodeDecodeError:
        iface.messageBar().pushCritical(
            "Input CSV File",
            "Bad CSV file - verify that your delimiters are consistent")
        return None

    infile.seek(0)
    reader = csv.reader(infile, dialect)

    # Decode from UTF-8 characters
    try:
        header = next(reader)
        header = [field for field in header]
    except IOError:
        iface.messageBar().pushCritical(
            "Input CSV File",
            "Invalid character in file - verify your file " +
            "uses UTF-8 character encoding")
        return None

    del reader
    del infile

    if not header:
        iface.messageBar().pushInfo(
            "Input CSV File",
            filename + " does not appear to be a CSV file")
        return None

    return header
